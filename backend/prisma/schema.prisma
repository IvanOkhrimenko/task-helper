generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  name          String
  role          UserRole  @default(USER)
  // Seller info for invoices
  address       String?
  nip           String?   // Tax ID (NIP in Poland)
  bankName      String?
  bankIban      String?
  bankSwift     String?

  // Notification preferences
  emailNotifications  Boolean @default(true)
  pushNotifications   Boolean @default(true)
  pushSubscription    Json?   // Web Push subscription data

  tasks             Task[]
  invoices          Invoice[]
  notifications     Notification[]
  googleAccounts    GoogleAccount[]
  chatConversations ChatConversation[]
  createdAt         DateTime  @default(now())
}

model Task {
  id            String    @id @default(uuid())
  type          TaskType  @default(INVOICE)
  name          String
  isActive      Boolean   @default(true)

  // Shared date fields (for INVOICE type - day of month)
  warningDate   Int?      // day of month for warning (1-31)
  deadlineDate  Int?      // day of month for deadline (1-31)

  // Invoice-specific data
  clientName        String?
  clientAddress     String?
  clientEmail       String?
  clientBankAccount String?   // Client's bank account number
  hourlyRate        Decimal?  @db.Decimal(10, 2)
  hoursWorked       Decimal?  @db.Decimal(10, 2)
  description       String?
  currency          String    @default("USD")
  defaultLanguage   String    @default("PL")  // PL, EN
  invoiceTemplate   InvoiceTemplate @default(STANDARD)  // Invoice PDF template style

  // Reminder-specific data
  scheduleType      ScheduleType?
  scheduleConfig    Json?         // {"time": "09:00", "daysOfWeek": [1,3,5]} etc.
  reminderDateTime  DateTime?     // For ONE_TIME reminders
  reminderWarning   Int?          // Minutes before to warn
  reminderDeadline  Int?          // Minutes after which it's overdue
  nextOccurrence    DateTime?     // Calculated next trigger time
  lastTriggered     DateTime?     // Last time reminder was triggered
  reminderTitle     String?       // Title for the reminder notification
  reminderMessage   String?       @db.Text // Message/description for reminder
  notificationEmail String?       // Custom email for notifications (if different from user's email)

  // Google account for Gmail drafts
  googleAccountId   String?
  googleAccount     GoogleAccount? @relation(fields: [googleAccountId], references: [id], onDelete: SetNull)

  // Email template fields for custom invoice emails
  emailSubjectTemplate   String?  @db.Text  // Custom subject template with placeholders
  emailBodyTemplate      String?  @db.Text  // Custom body template with placeholders
  useCustomEmailTemplate Boolean  @default(false)

  userId        String
  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  invoices      Invoice[]
  notifications Notification[]
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@index([userId, type])
  @@index([googleAccountId])
  @@index([nextOccurrence])
  @@index([isActive, nextOccurrence])
}

model Invoice {
  id           String        @id @default(uuid())
  number       String        @unique
  amount       Decimal       @db.Decimal(10, 2)
  currency     String        @default("USD")
  status       InvoiceStatus @default(DRAFT)
  pdfPath      String?
  emailSubject String?
  emailBody    String?       @db.Text
  comments     String?       @db.Text
  invoiceMonth Int?          // 0-11 (JavaScript month)
  invoiceYear  Int?
  hoursWorked  Decimal?      @db.Decimal(10, 2)
  hourlyRate   Decimal?      @db.Decimal(10, 2)
  language     String        @default("PL")  // PL, EN
  createdByAI  Boolean       @default(false) // True if created via AI assistant

  taskId    String
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@index([userId])
  @@index([taskId])
  @@index([status])
}

model Notification {
  id            String             @id @default(uuid())
  type          NotificationType
  status        NotificationStatus @default(PENDING)
  title         String
  message       String             @db.Text
  scheduledFor  DateTime
  sentAt        DateTime?
  readAt        DateTime?
  metadata      Json?              // Additional data for templates etc.

  taskId        String?
  task          Task?              @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId        String
  user          User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @default(now()) @updatedAt

  @@index([userId, status])
  @@index([scheduledFor, status])
  @@index([taskId])
}

model GoogleAccount {
  id            String   @id @default(uuid())
  email         String
  accessToken   String   @db.Text
  refreshToken  String   @db.Text
  expiresAt     DateTime

  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  tasks         Task[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([userId, email])
  @@index([userId])
}

enum TaskType {
  INVOICE
  REMINDER
}

enum InvoiceTemplate {
  STANDARD    // Default professional template
  MINIMAL     // Clean, simple design
  MODERN      // Contemporary with accent colors
  CORPORATE   // Formal business style
  CREATIVE    // Bold, artistic design
  ELEGANT     // Sophisticated serif typography
}

enum ScheduleType {
  ONE_TIME
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
  CUSTOM
}

enum NotificationType {
  IN_APP
  BROWSER_PUSH
  EMAIL
}

enum NotificationStatus {
  PENDING
  SENT
  READ
  FAILED
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  CANCELLED
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

// AI Chat enums
enum AIProvider {
  CLAUDE
  OPENAI
  LOCAL
}

enum ChatRole {
  USER
  ASSISTANT
  SYSTEM
  TOOL
}

enum ActionStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

// Integration Settings (global, app-level - Google, etc.)
model IntegrationSettings {
  id                  String   @id @default(uuid())

  // Google OAuth credentials
  googleClientId      String?  @db.Text
  googleClientSecret  String?  @db.Text
  googleRedirectUri   String?  @db.Text

  // Status
  googleEnabled       Boolean  @default(false)

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

// AI Chat Settings (global, app-level)
model AIChatSettings {
  id          String     @id @default(uuid())
  provider    AIProvider @default(CLAUDE)
  modelId     String     @default("claude-sonnet-4-20250514")
  maxTokens   Int        @default(4096)
  temperature Float      @default(0.7)

  // API Keys (stored encrypted or plain - admin responsible for security)
  claudeApiKey  String?    @db.Text  // Anthropic API key
  openaiApiKey  String?    @db.Text  // OpenAI API key (for future use)

  // Status
  isActive      Boolean    @default(true)

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

// Chat conversation session
model ChatConversation {
  id       String        @id @default(uuid())
  userId   String
  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  title    String?
  isActive Boolean       @default(true)

  messages ChatMessage[]

  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@index([userId, isActive])
  @@index([userId, updatedAt])
}

// Individual chat message
model ChatMessage {
  id             String           @id @default(uuid())
  conversationId String
  conversation   ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  role           ChatRole
  content        String           @db.Text

  toolCalls      Json?            // Array of tool calls made by assistant
  toolCallId     String?          // If this is a tool result message

  tokenCount     Int?
  processingMs   Int?             // Response time in milliseconds

  createdAt      DateTime         @default(now())

  @@index([conversationId, createdAt])
}

// Pending action awaiting user confirmation
model ChatPendingAction {
  id             String       @id @default(uuid())
  conversationId String
  messageId      String

  toolName       String
  toolArgs       Json
  toolCallId     String?      // Original Claude API tool_use_id for proper message pairing
  status         ActionStatus @default(PENDING)

  expiresAt      DateTime
  resolvedAt     DateTime?

  createdAt      DateTime     @default(now())

  @@index([conversationId, status])
}
